---
categories: 
- k8s
tags:
- k8s
---
## Kubernetes简介
Kubernetes（简称K8S，K和S之间有8个字母）是用于自动部署，扩展和管理容器化应用程序的开源系统。它将组成应用程序的容器组合成逻辑单元，
以便于管理和服务发现。Kubernetes 源自Google 15 年生产环境的运维经验，同时凝聚了社区的最佳创意和实践。  


## Kubernetes特性
* 服务发现与负载均衡:无需修改你的应用程序即可使用陌生的服务发现机制。
* 存储编排:自动挂载所选存储系统，包括本地存储。
* Secret和配置管理: 部署更新Secrets和应用程序的配置时不必重新构建容器镜像，且不必将软件堆栈配置中的秘密信息暴露出来。
* 批量执行: 除了服务之外，Kubernetes还可以管理你的批处理和CI工作负载，在期望时替换掉失效的容器。
* 水平扩缩:使用一个简单的命令、一个UI或基于CPU使用情况自动对应用程序进行扩缩。
* 自动化上线和回滚: Kubernetes会分步骤地将针对应用或其配置的更改上线，同时监视应用程序运行状况以确保你不会同时终止所有实例。
* 自动装箱:根据资源需求和其他约束自动放置容器，同时避免影响可用性。
* 自我修复:重新启动失败的容器，在节点死亡时替换并重新调度容器，杀死不响应用户定义的健康检查的容器。


## Minikube
Minikube是一种轻量级的Kubernetes实现，可在本地计算机上创建VM并部署仅包含一个节点的简单集群，Minikube可用于Linux、MacOS和Windows系统。
Minikube CLI提供了用于引导集群工作的多种操作，包括启动、停止、查看状态和删除。

## Kubernetes核心组件

### master组件
* apiserver 集群统一入口，以restful方式，交给etcd存储
* scheduler 节点调度，选择node节点部署应用
* controller-manager 处理集群中常规后台任务，一个资源对应一个控制器
* etcd 分布式存储数据库，保存集群相关数据

### Node
* kubelet master派到node节点代表，管理本机容器
* kube-proxy 提供网络代理、负载均衡等操作


## k8s核心概念

### Pod 
* k8s中最小的部署单元
* 一组容器的集合
* 一个Pod中的容器共享网络、存储
* 生命周期是短暂的

### controller
* 确保预期的pod的副本的数量
* 无状态的应用部署
* 有状态的应用部署
> 确保所有的node运行一个pod,一次性任务和定时任务



### service
* 定义一组pod的访问规则




## 搭建k8s集群

### 搭建k8s环境平台规则

#### 单master集群

#### 多master集群
node通过一个负载均衡机制和master交互

### 服务器硬件配置要求
#### 测试环境
* master 2核 4g 20g
* node 4核 8g 40g


### 搭建k8s集群部署方式
#### kubeadm
kubeadm 是官方社区退出的一个用于快速部署k8s集群的工具，这个工具能通过两条指令完成一个k8s集群的部署

#### 二进制包


## 单master集群

### vmware 准备虚拟机
* Nat模式 修改子网Ip 192.168.137.0 ，nat网关 192.168.137.254
* 虚拟机内部配置ip https://blog.csdn.net/llluluyi/article/details/79041791 
>> /etc/sysconfig/network-scripts 
### 环境准备
* 一台或多台机器，操作系统 centos7
* 硬件配置，2g 2cpu 30g
* 集群之间所有机器网络互通
* 可以访问外网，需要拉取镜像
* 禁用swap分区


### 操作系统初始化工作
```
# 关闭防火墙
systemctl stop firewalld  # 临时处理
systemctl disable firewalld # 永久处理

# 关闭selinux
sed -i 's/enforcing/disabled/' /etc/selinux/config # 永久
setenforce 0 #临时

# 关闭swap 
swapoff -a # 临时
sed -ri 's/.*swap.*/#&/' /etc/fstab # 永久

# 根据规划设置主机名
hostnamectl set-hostname <hostname> 
例如：
hostnamectl set-hostname k8s-master
hostnamectl set-hostname node1

# 在master添加hosts
cat >> /etc/hosts <<EOF
192.168.137.100 k8s-master
192.168.137.101 k8s-node1
192.168.137.102 k8s-node2
192.168.137.103 k8s-node3
EOF

# 将桥接的IPv4 流量传递到iptables的链
cat > /etc/sysctl.d/k8s.conf << EOF
net.bridge.bridge-nf-call-ip6tables = 1 
net.bridge.bridge-nf-call-iptables = 1 
EOF

sysctl --system # 生效配置

# 时间同步
yum install ntpdate -y
ntpdate time.windows.com

```

### 所有节点安装docker/kubeadm/kubelet

#### 安装docker 
首先配置一下Docker的阿里yum源  
```
cat >/etc/yum.repos.d/docker.repo<<EOF
[docker-ce-edge]
name=Docker CE Edge - \$basearch
baseurl=https://mirrors.aliyun.com/docker-ce/linux/centos/7/\$basearch/edge
enabled=1
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/docker-ce/linux/centos/gpg
EOF
```
yum方式安装docker  
```
# yum安装
yum -y install docker-ce

# 查看docker版本
docker --version  

# 启动docker
systemctl enable docker
systemctl start docker
```

```
cat >> /etc/docker/daemon.json << EOF
{
  "registry-mirrors": ["https://b9pmyelo.mirror.aliyuncs.com"]
}
EOF
```
#### 安装kubeadm，kubelet和kubectl

配置一下yum的k8s软件源  
```
cat > /etc/yum.repos.d/kubernetes.repo << EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
```
由于版本更新频繁，这里指定版本号部署： 
```
# 安装kubelet、kubeadm、kubectl，同时指定版本
yum install -y kubelet-1.18.0 kubeadm-1.18.0 kubectl-1.18.0
# 设置开机启动
systemctl enable kubelet
```

### 部署Kubernetes Master【master节点】
```
kubeadm init --apiserver-advertise-address=192.168.137.100 --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.18.0 --service-cidr=10.96.0.0/12  --pod-network-cidr=10.244.0.0/16
```
使用kubectl工具 【master节点操作】    
```
  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

### 将节点加入到集群中
此命令由kubeadm init 时生产的
```
kubeadm join 192.168.137.100:6443 --token v17di1.mxjh3ryz2clh5mfk \
    --discovery-token-ca-cert-hash sha256:c33735da514c8d79e2af43b37a00bcea660fe13489566235c4a1c082e100a15b
```
### 部署CNI网络插件
```
# 添加
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

##①首先下载v0.13.1-rc2-amd64 镜像
##参考博客：https://www.cnblogs.com/pyxuexi/p/14288591.html
##② 导入镜像，命令，，特别提示，3个机器都需要导入，3个机器都需要导入，3个机器都需要导入，3个机器都需要导入，重要的事情说3遍。不然抱错。如果没有操作，报错后，需要删除节点，重置，在导入镜像，重新加入才行。本地就是这样操作成功的！
docker load < flanneld-v0.13.1-rc2-amd64.docker
#####下载本地，替换将image: quay.io/coreos/flannel:v0.13.1-rc2 替换为 image: quay.io/coreos/flannel:v0.13.1-rc2-amd64

# 查看状态 【kube-system是k8s中的最小单元】
kubectl get pods -n kube-system
```




















